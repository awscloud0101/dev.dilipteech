@model AsteriskBrowserAL.Models.StudentAdmissionRegisterData
@{

    List<AsteriskBrowserAL.Models.StudentAdmissionRegisterData> StudentAdmittedDetails = new List<AsteriskBrowserAL.Models.StudentAdmissionRegisterData>();
    List<AsteriskBrowserAL.Models.FeeParticularViewModel> Particulars = new List<AsteriskBrowserAL.Models.FeeParticularViewModel>();
    if (null != Model)
    {
        if (StudentAdmittedDetails.Count() > 0)
        {
            var Feeparticulars = Model.StudentAdmittedDetails.FirstOrDefault();

            if (null != Feeparticulars)
            {
                Particulars = Feeparticulars.FeeparticularsData.ToList();
            }
        }
    }

    int sno = 1;
}





@Html.Action("DataTableScripts", "Base")


@if (null != Model)
{
    if (Model.StudentAdmittedDetails.Count() > 0)
    {
        <div class="table-header">
            Records Found (@Model.StudentAdmittedDetails.Count())
            <div style="float:right;margin-right:10px;">
                <button class="btncustom" id="btnExport">
                    Download
                </button>
                <button class="btncustom" id="btnPrint">
                    Print
                </button>
            </div>
        </div>


        <div id="Print" style="font-size:14px;border-collapse:collapse;width:100%">

                <div class="table-responsive">
                    <table id="tbFeeDueReportData" class="table tbhover table-striped table-bordered dynamic-table" style="font-size:14px;border-collapse:collapse;width:100%" border="1">
                        <thead>
                            <tr>
                                <th colspan="10" style="text-align:center">Student Details </th>
                                <th colspan="4" style="text-align:center">Admission Fee</th>
                                <th colspan="4" style="text-align:center">Tution Fee</th>
                                <th colspan="4" style="text-align:center">Transport Fee</th>
                                <th colspan="4" style="text-align:center">Summary</th>
                            </tr>

                            <tr>
                                <th>
                                    S.No.
                                </th>

                                <th>
                                    @Html.DisplayName("Branch Name")
                                </th>
                                <th>
                                    @Html.DisplayName("Date")
                                </th>

                                <th style="min-width:200px">
                                    @Html.DisplayName("Student")
                                </th>
                                <th>
                                    @Html.DisplayName("Admission Number")
                                </th>
                                <th>
                                    @Html.DisplayName("Section")
                                </th>

                                <th>
                                    @Html.DisplayName("Father Name")
                                </th>

                                <th>
                                    @Html.DisplayName("Father Mobile Number")
                                </th>
                                <th style="min-width:200px">
                                    @Html.DisplayName("Reference Name")
                                </th>

                                <th>
                                    @Html.DisplayName("Employee Id")
                                </th>

                                <th>
                                    @Html.DisplayName("Amount")
                                </th>
                                <th>
                                    @Html.DisplayName("Paid Amount")
                                </th>
                                <th>
                                    @Html.DisplayName("Total Concession")
                                </th>
                                <th>
                                    @Html.DisplayName("Due")
                                </th>

                                <th>
                                    @Html.DisplayName("Amount")
                                </th>

                                <th>
                                    @Html.DisplayName("Paid Amount")
                                </th>
                                <th>
                                    @Html.DisplayName("Total Concession")
                                </th>

                                <th>
                                    @Html.DisplayName("Due")
                                </th>

                                <th>
                                    @Html.DisplayName("Amount")
                                </th>

                                <th>
                                    @Html.DisplayName("Paid Amount")
                                </th>
                                <th>
                                    @Html.DisplayName("Total Concession")
                                </th>

                                <th>
                                    @Html.DisplayName("Due")
                                </th>

                                <th>
                                    @Html.DisplayName("Total Amount")
                                </th>

                                <th>
                                    @Html.DisplayName("Total Paid Amount")
                                </th>
                                <th>
                                    @Html.DisplayName("Total Concession")
                                </th>
                                <th>
                                    @Html.DisplayName("Total Due")
                                </th>


                            </tr>
                        </thead>

                        <tbody>
                            @for (int i = 0; i < Model.StudentAdmittedDetails.Count(); i++)
                    {
                        double TotalSum = Model.StudentAdmittedDetails.ElementAt(i).FeeparticularsData.Where(s => s.TransactionTypeId == 0).Sum(s => s.InstallmentAmount);
                        double TotalBalance = Model.StudentAdmittedDetails.ElementAt(i).FeeparticularsData.Where(s => s.TransactionTypeId == 0).Sum(s => s.BalanceAmount);
                        double valTotalBalance = Model.StudentAdmittedDetails.ElementAt(i).FeeparticularsData.Where(s => s.TransactionTypeId == 0).Sum(s => s.ValBalanceAmount);
                        double PaidAmount = TotalSum - valTotalBalance;

                        double TransportTotalSum = Model.StudentAdmittedDetails.ElementAt(i).FeeparticularsData.Where(s => s.TransactionTypeId == 1).Sum(s => s.InstallmentAmount);
                        double TransportTotalBalance = Model.StudentAdmittedDetails.ElementAt(i).FeeparticularsData.Where(s => s.TransactionTypeId == 1).Sum(s => s.BalanceAmount);
                        double valTransportTotalBalance = Model.StudentAdmittedDetails.ElementAt(i).FeeparticularsData.Where(s => s.TransactionTypeId == 1).Sum(s => s.ValBalanceAmount);
                        double TransportPaidAmount = TransportTotalSum - valTransportTotalBalance;


                        double TotalDiscount = Model.StudentAdmittedDetails.ElementAt(i).FeeparticularsData.Where(s => s.TransactionTypeId == 0).Sum(s => s.DiscountAmount);
                        double TransportTotalDiscount = Model.StudentAdmittedDetails.ElementAt(i).FeeparticularsData.Where(s => s.TransactionTypeId == 1).Sum(s => s.DiscountAmount);

                        double AdmissionTotalSum = Model.StudentAdmittedDetails.ElementAt(i).FeeparticularsData.Where(s => s.TransactionTypeId == 2 && s.ParticularName == "Admission Fee").Sum(s => s.InstallmentAmount);
                        double AdmissionTotalBalance = Model.StudentAdmittedDetails.ElementAt(i).FeeparticularsData.Where(s => s.TransactionTypeId == 2 && s.ParticularName == "Admission Fee").Sum(s => s.BalanceAmount);
                        double valAdmissionTotalBalance = Model.StudentAdmittedDetails.ElementAt(i).FeeparticularsData.Where(s => s.TransactionTypeId == 2 && s.ParticularName == "Admission Fee").Sum(s => s.ValBalanceAmount);

                        double AdmissionTotalDiscount = Model.StudentAdmittedDetails.ElementAt(i).FeeparticularsData.Where(s => s.TransactionTypeId == 2 && s.ParticularName == "Admission Fee").Sum(s => s.DiscountAmount);
                        double AdmissionFeePaidAmount = AdmissionTotalSum - valAdmissionTotalBalance;

                        double TotalAllAmount = TotalSum + TransportTotalSum + AdmissionTotalSum;
                        double TotalAllPaidAmount = PaidAmount + TransportPaidAmount + AdmissionFeePaidAmount;
                        double TotalAllDiscountAmount = TotalDiscount + TransportTotalDiscount + AdmissionTotalDiscount;
                        double TotalDueAmount = TotalBalance + TransportTotalBalance + AdmissionTotalBalance;

                        if (TotalBalance > 0 || AdmissionTotalBalance > 0)
                        {
                                    <tr>
                                        <td>
                                            @sno
                                        </td>
                                        <td>
                                            @Model.StudentAdmittedDetails.ElementAt(i).BranchName
                                        </td>
                                        <td>
                                            @Model.StudentAdmittedDetails.ElementAt(i).AdmissionDate.Value.ToString("dd - MMM - yyyy")
                                        </td>
                                        <td>
                                            @Model.StudentAdmittedDetails.ElementAt(i).FirstName
                                        </td>

                                        <td>
                                            @Model.StudentAdmittedDetails.ElementAt(i).StudentAdmissionNumber

                                        </td>
                                        <td>
                                            @Model.StudentAdmittedDetails.ElementAt(i).SectionName
                                        </td>

                                        <td>
                                            @Model.StudentAdmittedDetails.ElementAt(i).FatherName
                                        </td>

                                        <td>
                                            @Model.StudentAdmittedDetails.ElementAt(i).FatherMobileNumber
                                        </td>

                                        <td>
                                            @Model.StudentAdmittedDetails.ElementAt(i).SchoolReferenceName
                                        </td>

                                        <td>
                                            @Model.StudentAdmittedDetails.ElementAt(i).EmployeeNumber
                                        </td>

                                        @if (Model.StudentAdmittedDetails.ElementAt(i).IsNew == true)
                            {
                                            <td>
                                                @AdmissionTotalSum
                                            </td>
                                            <td>@AdmissionFeePaidAmount</td>
                                            <td>
                                                @AdmissionTotalDiscount
                                            </td>
                                            <td>@AdmissionTotalBalance</td>
                                        }
                                        <td>
                                            @TotalSum
                                        </td>
                                        <td>
                                            @PaidAmount
                                        </td>
                                        <td>@TotalDiscount</td>
                                        <td>@TotalBalance</td>

                                        @if (TransportTotalSum > 0)
                            {
                                            <td>
                                                @TransportTotalSum
                                            </td>
                                            <td>
                                                @TransportPaidAmount
                                            </td>
                                            <td>@TransportTotalDiscount</td>
                                            <td>@TransportTotalBalance</td>
                                        }
                                        else
                                        {
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        }

                                        <td>@TotalAllAmount</td>
                                        <td>@TotalAllPaidAmount</td>
                                        <td>@TotalAllDiscountAmount</td>
                                        <td>@TotalDueAmount</td>
                                    </tr>
                                    sno++;
                                }
                            }
                        </tbody>
                    </table>

                </div>

            </div>

                }
                else
                {
                <div style="color:red;font-weight:bold">Data not available to display</div>
                }
                }



                <script>

                    $('#search-btn').on('click', function (e) {
                        debugger
                        e.preventDefault();
                        $.ajax({
                            url: '/AReports/StudentAdmitteddataWithPaging/',
                            data: { page: 0, strSearch: $('#Search-txt').val() },
                            type: 'GET',
                            cache: false,
                            success: function (result) {
                                $('#AdmittedStudentRortdata').html(result);
                            }
                        });
                    });


                    $("#btnExport").click(function (e) {
                        debugger
                        window.location.href = "/AReports/ExcelStudentDmittedReportDT"
                        var Data = $("#tbFeeDueReportData").html();
                    });
                    $('#btnPrint').click(function () {
                        var Columns = 5;
                        var value = 2;
                        var CourseId = 1;
                        var SectionId = 1;
                        $.ajax({
                            url: '/AReports/PrintDT',
                            data: { Columns: Columns, Status: value, CourseId: CourseId, SectionId: SectionId },
                            success: function (data) {
                                debugger
                                PrintData(data);
                            },
                        })


                        debugger
                        //Old 
                        //PrintElem('#Print');
                    });

                    //New
                    function PrintData(data) {
                        var mywindow = window.open('', 'my div', 'height=300,width=600,size=landscape');
                        mywindow.document.write('<p></p>');
                        mywindow.document.write(data);
                        mywindow.document.write('<p></p>');
                        mywindow.document.close();
                        mywindow.focus();
                        mywindow.print();
                        mywindow.close();
                        return true;
                    }
                    //window.onload = onloadData();

                    function PrintElem(elem) {

                        Popup(document.getElementById("Print").innerHTML)
                    }

                    function Popup(data) {

                        var mywindow = window.open('', 'my div', 'size=landscape;width: 50%;margin=0;padding=0;');
                        mywindow.document.write('<p></p>');
                        mywindow.document.write(data);
                        mywindow.document.write('<p></p>');

                        var is_chrome = Boolean(mywindow.chrome);

                        if (is_chrome) {
                            setTimeout(function () { // wait until all resources loaded
                                mywindow.document.close();
                                mywindow.focus();
                                mywindow.print();
                                mywindow.close();
                                window.location.href = "/AReports/AdmittedStudentsReport";

                            }, 2050);
                        } else {
                            mywindow.document.close();
                            mywindow.focus();
                            mywindow.print();
                            mywindow.close();
                            window.location.href = "/AReports/AdmittedStudentsReport";

                        }

                        return true;
                    }


                </script>











