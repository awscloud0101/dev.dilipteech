@model IEnumerable<AsteriskBrowserAL.Models.RunPayrollViewData>
@{
    ViewBag.Title = "GenerateSalaryStatement";
    int sno = 1;
}

@section BreadCrumb{

    <ul class="breadcrumb">
        <li>
            <i class="menu-icon fa fa-list"></i>
            HR
        </li>
        <li>
            <i class=""></i>
            Payroll
        </li>
        <li class="active">Generate Salary Statement</li>
    </ul><!-- /.breadcrumb -->
}



<section class="content">
    
    <br />

    <div class="box">
        <div class="box-body">
            <div class="row">
                <div class="form-group">
                    <input type="hidden" value="@ViewBag.branch" id="branch"/>
                    <div class="col-sm-6">
                        <label class="col-sm-3 control-label no-padding-right">@Html.Label("Month")</label>
                        <div class="col-sm-6">
                            @Html.DropDownList("YearAndMnth", null, "--- Select ---", new { @class = "form-control", @onchange = "GetBankStatementData();" })
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
        <div id="tableData" style="display:none;">
                <div class="box">
                    <div class="box-header">
                        <h3 class="box-title">Salary Statement</h3>
                    <br/>
                    <br/>
                        <button id="btnExport" class="btn btn-primary">Generate</button>
                    </div><!-- /.box-header -->
                    <div class="box-body">
                        <div id="dvData">
                            <table class="table table-striped table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>
                                            SNo
                                        </th>
                                        <th>
                                            Employee Name
                                        </th>
                                        <th>
                                            New Salary
                                        </th>
                                        <th>
                                            Gross
                                        </th>
                                        <th>
                                            PF
                                        </th>
                                        <th>
                                            TDS
                                        </th>
                                        @*<th>
                                            Professional Tax
                                        </th>*@
                                        <th>
                                            Net Amount
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="tbody"></tbody>
                                @*@foreach (var item in Model)
                            {
                                    <tr>
                                        <td>
                                            @(sno++)
                                        </td>
                                        <td>
                                            @item.EmployeeName
                                        </td>
                                        <td>
                                            @item.Earnings
                                        </td>
                                        <td>
                                            @item.GrossSalary
                                        </td>
                                        <td>
                                            @item.D1
                                        </td>
                                        <td>
                                            @item.D2
                                        </td>
                                        <td>
                                            @item.RecordCount
                                        </td>
                                        <td>
                                            @item.NetAmount
                                        </td>
                                    </tr>
                            }*@

                            </table>
                        </div>
                    </div>
                </div>
            </div>
    <span style="color:red;font-weight:bold;display:none" id="message">Data is not available</span>
</section>

<script type="text/javascript">
   
    //$("#btnExport").click(function (e) {
    //    window.open('data:application/vnd.ms-excel,' + $('#dvData').html());
    //    e.preventDefault();
    //});

    function GetBankStatementData() {
        $('#message').hide();
        var yearmonth = $('#YearAndMnth').val();
        var nBranch = $('#branch').val();
        if (yearmonth != null && yearmonth != "") {
            $.ajax({
                url: '/HRPayroll/GetSalaryStatementData',
                data: { strYearMonth: yearmonth, nBranch: nBranch },
                success: function (data) {
                    var row = "";
                    var sno = 1;

                    if (data.length > 0)
                        $('#tableData').show();

                    else {
                        $('#tableData').hide();
                        $('#message').show();
                        return;
                    }

                    $.each(data, function (i, data) {
                        row += "<tr>" +
                        "<td>" + (sno++) + "</td>" +
                        "<td>" + data.EmployeeName + "</td>" +
                        "<td>" + data.Earnings + "</td>" +
                        "<td>" + data.GrossSalary + "</td>" +
                        "<td>" + data.D1 + "</td>" +
                        "<td>" + data.D2 + "</td>" +
                        //"<td>" + data.RecordCount + "</td>" +
                        "<td>" + data.NetAmount + "</td>" +
                        "</tr>";
                    });
                    $("#tbody").html(row);
                },

                asyn: false,
            });
        }
        else {
            $('#tableData').hide();
            $('#message').show();
        }
    }

    $(document).ready(function () {
        $("#btnExport").click(function (e) {

            var filename = "Salary Statement_" + $('#YearAndMnth').val()
            //creating a temporary HTML link element (they support setting file names)
            var a = document.createElement('a');
            //getting data from our div that contains the HTML table
            var data_type = 'data:application/vnd.ms-excel';
            var table_div = document.getElementById('dvData');
            var table_html = table_div.outerHTML.replace(/ /g, '%20');
            a.href = data_type + ', ' + table_html;
            //setting the file name
            a.download = filename + '.xls';
            //triggering the function
            a.click();
            //just in case, prevent default behaviour
            e.preventDefault();
        });
    });

</script>
