@model AsteriskBrowserAL.Models.HDTicketsData

@{
    int nsno = 1;
    ViewBag.Title = "Edit Ticket";
}

<!-- #section:basics/content.breadcrumbs -->
<section class="content-header">
    <ol class="breadcrumb">
        <li>
            <i class="menu-icon fa fa-list"></i>
            Transactions
        </li>
        <li>
            <i class=""></i>
            Help Desk
        </li>
        <li class="active">Open Ticket</li>
    </ol>
    <!-- /section:basics/content.breadcrumbs -->
</section>

<style>
    .required:first-letter {
        color: red;
        font-weight: bold;
    }
</style>

<section class="content">
    <div class="row">
        <div class="col-xs-12">
            @*<h3>@Html.ActionLink("<< Tickets", "OpenTicket", new { priorityId = @Model.SelpriorityId, StatusId = @Model.SelStatusId })</h3>*@
        </div>
    </div>
    <div class="table-header">
        
            <small style="float:right;" class="textheader">
                @Html.ActionLink("Back to details", "OpenTicket", new { priorityId = @Model.SelpriorityId, StatusId = @Model.SelStatusId })
            </small>
   
    </div>
    <div class="row">
        <div class="col-xs-12">
            @using (Html.BeginForm("OpenTicketE", "HDOperations", FormMethod.Post, new { @class = "form-horizontal" }))
            {

                @Html.HiddenFor(model => model.HDTaskId)
                @Html.HiddenFor(model => model.HDTicketId)
                @Html.HiddenFor(model => model.TicketNumber)
                @Html.HiddenFor(model => model.Subject)
                @Html.HiddenFor(model => model.TicketDate)
                @Html.HiddenFor(model => model.HDTicketTypeId)
                @Html.HiddenFor(model => model.HDTicketOwnerId)
                @Html.HiddenFor(model => model.SelpriorityId)
                @Html.HiddenFor(model => model.SelStatusId)
                @Html.HiddenFor(model => model.PlayerId)

                <div class="widget-box">
                    <span style="color:red;font-weight:bold;">@Html.ValidationMessage("OpenTicketE")</span>
                    <div class="widget-header widget-header-flat widget-header-small">
                        <h5 class="widget-title">
                            @if (!string.IsNullOrWhiteSpace(Model.Subject))
                            {
                                @Model.Subject.ToUpper()
                            }
                        </h5>
                        <button class="btn btn-success btn-sm" onclick="return Validations();" type="submit" style="float:right">
                            <i class="ace-icon fa  bigger-50"></i>
                            Send
                        </button>
                    </div><!-- /.page-header -->
                    <!-- form start -->

                    <div class="widget-body">
                        <div class="widget-main">
                            <div class="form-group">
                                <label class="col-sm-3 control-label no-padding-right" for="form-field-1">@Html.Label("Ticket ID")</label>

                                <div class="col-sm-3">
                                    <label class="control-label no-padding-right" for="form-field-1"><b>@Model.TicketNumber</b></label>

                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label no-padding-right" for="form-field-1">@Html.Label("Created On")</label>

                                <div class="col-sm-3">
                                    <label class="control-label no-padding-right" for="form-field-1"><b>@Model.TicketDate.Value.ToString("dd-MMM-yyyy")</b></label>

                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-sm-3 control-label no-padding-right" for="form-field-1">@Html.Label("Updated On")</label>

                                <div class="col-sm-3">
                                    <label class="control-label no-padding-right" for="form-field-1"><b>@Model.StatusDate.Value.ToString("dd-MMM-yyyy")</b></label>

                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label no-padding-right" for="form-field-1">@Html.Label("Owner")</label>

                                <div class="col-sm-3">
                                    <label class="control-label no-padding-right" for="form-field-1"><b>@Model.HdTicketOwnerName</b></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label no-padding-right" for="form-field-1">@Html.Label("Category")</label>

                                <div class="col-sm-3">
                                    <label class="control-label no-padding-right" for="form-field-1"><b>@Model.CategoryName</b></label>
                                </div>


                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label no-padding-right required" for="form-field-1">*Priority</label>

                                <div class="col-sm-3">
                                    @Html.DropDownListFor(model => model.PriorityId, new SelectList(Model.ListPriority, "HDPriorityId", "Priority"), "--- Select ---", new { @class = "form-control" })
                                </div>

                                <div class="col-sm-3">
                                    <label style="color:red;font-weight:bold;" id="PriorityIdVal"> </label>
                                </div>
                            </div>
                            @*<div class="form-group">
                                <label class="col-sm-3 control-label no-padding-right required" for="form-field-1">*Issue Type</label>

                                <div class="col-sm-3">
                                    @Html.DropDownListFor(model => model.HDTicketTypeId, new SelectList(Model.ListTicketType, "HDTicketTypeId", "HDTicketTypeName"), "--- Select ---", new { @class = "form-control" })
                                </div>

                                <div class="col-sm-3">
                                    <label style="color:red;font-weight:bold;" id="HDTicketTypeIdVal"> </label>
                                </div>
                            </div>*@

                            <div class="form-group">
                                <label class="col-sm-3 control-label no-padding-right required" for="form-field-1">*Status</label>

                                <div class="col-sm-3">
                                    @Html.DropDownListFor(model => model.HDTicketStatus, new SelectList(Model.ListStatus, "HDStatusId", "HDStatusName"), "-- Select --", new { @class = "form-control", @id = "HDStatusId" })
                                </div>

                                <div class="col-sm-3">
                                    <label style="color:red;font-weight:bold;" id="HDStatusIdVal"> </label>
                                </div>
                            </div>

                            <div class="form-group" id="divGroup">
                                <label class="col-sm-3 control-label no-padding-right required" for="form-field-1">*Group</label>

                                <div class="col-sm-3">
                                    @Html.DropDownListFor(model => model.GroupId, new SelectList(Model.ListGroups, "HDExecutiveGroupId", "GroupName"), "--- Select ---", new { @class = "form-control" })
                                </div>

                                <div class="col-sm-3">
                                    <label style="color:red;font-weight:bold;display:none;" id="HDGroupIdVal"> Select Group</label>
                                </div>
                            </div>


                            @*<div class="form-group" id="divStatusOwner">
                                <label class="col-sm-3 control-label no-padding-right required" for="form-field-1">*Send Request To</label>

                                <div class="col-sm-3">
                                    @Html.DropDownListFor(model => model.HDTicketStatusOwnerId, new SelectList(Model.lstDescendents, "StaffId", "EmployeeName"), "--- Select ---", new { @class = "form-control" })
                                </div>

                                <div class="col-sm-3">
                                    <label style="color:red;font-weight:bold;" id="HDTicketStatusOwnerIdVal"> </label>
                                </div>
                            </div>*@

                            <div class="form-group">
                                <label class="col-sm-3 control-label no-padding-right required" for="form-field-1">*Comment</label>

                                <div class="col-sm-3">
                                    @Html.TextAreaFor(model => model.TaskDescription, 4, 2, new { @class = "form-control col-sm-5", @id = "TaskDescription", placeholder = "Description" })
                                </div>
                                <div class="col-sm-3" style="display:none;" id="CommentVal">
                                    <label style="color:red;font-weight:bold;"> Enter Comment </label>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                if (null != Model.Comments && Model.Comments.Count() > 0)
                {

                    <div class="row">
                        <div class="col-sm-12">
                            <div class="widget-box">
                                <div class="widget-header">
                                    <h4 class="widget-title lighter smaller">
                                        <i class="ace-icon fa fa-comment blue"></i>
                                        Replies @(!string.IsNullOrWhiteSpace(Model.Description) ? Model.Description.ToUpper() : "") <span data-toggle="tooltip" title="3 New Messages" class="badge bg-yellow">@Model.Comments.Count()</span>
                                    </h4>
                                </div>

                                <div class="widget-body">
                                    <div class="widget-main no-padding">
                                        <div class="dialogs ace-scroll">
                                            <div class="scroll-track scroll-active" style="display: block; height: 300px;"><div class="scroll-bar" style="height: 236px; top: 0px;"></div></div><div class="scroll-content" style="max-height: 300px;">
                                                @{
                                                    int count = Model.Comments.Count();
                                                    string stfName = "";
                                                }
                                                @for (int i = 0; i < Model.Comments.Count(); i++)
                                                {
                                                    stfName = "";
                                                    if (count > i + 1)
                                                    {
                                                        stfName = "to " + Model.Comments.ElementAt(i + 1).HdTicketStatusOwnerName;
                                                    }
                                            <div class="itemdiv dialogdiv">
                                                <div class="user">
                                                    @* <img alt="Alexa's Avatar" src="assets/avatars/avatar1.png">*@
                                                    <img src="~/Content/images/NoPhoto.jpg" />
                                                </div>
                                                <div class="body">
                                                    <div class="time">
                                                        <i class="ace-icon fa fa-clock-o"></i>
                                                        <span class="green">@Model.Comments.ElementAt(i).StatusDate.Value.ToString("dd-MMM-yyyy")</span>
                                                    </div>
                                                    <div class="name">

                                                        <a>@Model.Comments.ElementAt(i).HdTicketStatusOwnerName  @stfName</a>
                                                    </div>
                                                    <div class="text">@Model.Comments.ElementAt(i).Description</div>
                                                </div>
                                            </div>

                                                }

                                            </div>
                                        </div>
                                    </div><!-- /.widget-main -->
                                </div><!-- /.widget-body -->
                            </div>
                        </div>
                    </div>

                                                        }

                                                    }
        </div>

    </div>
    <input type="hidden" id="HDStatusIdSel" value="@Model.HDTicketStatus" />
    <input type="hidden" id="PriorityIdSel" value="@Model.PriorityId" />
    <input type="hidden" id="HDTicketTypeIdSel" value="@Model.HDTicketTypeId" />
    <input type="hidden" id="TicketCategoryIdSel" value="@Model.TicketCategoryId" />

    <input type="hidden" id="HDTicketStatusOwnerIdSel" value="@Model.HDTicketStatusOwnerId" />
    <input type="hidden" id="HDTicketOwnerIdSel" value="@Model.HDTicketOwnerId" />
    <input type="hidden" id="StatusOwnerEmployeeNo" value="@Model.HDTicketStatusOwnerId" />
    <input type="hidden" id="SelDepartmentId" value="@Model.DepartmentId" />
</section>


<script type="text/javascript">

    $("#go").click(function () {
        var fd = new FormData();
        fd.append("file", document.getElementById('fileInput').files[0]);
        $.ajax({
            url: "/MCalendar/HolidaysC/",
            type: 'POST',
            data: fd,
            processData: false,
            contentType: false,
            Success: function () {

            }
        })
    });

    function LosadPriority() {
        $.ajax({
            url: "/HDOperations/LoadPriorities",
            success: function (data) {
                var PriorityItems = $('#PriorityId')
                PriorityItems.children().remove();
                PriorityItems.append($("<option>").val("null").text("--Select--"))
                $.each(data, function (i, record) {
                    PriorityItems.append($("<option>").val(record.HDPriorityId).text(record.Priority));
                });
                $('#PriorityId').append(PriorityItems);
                var SelPriorityId = $("#PriorityIdSel").val()
                if (SelPriorityId > 0) {
                    document.getElementById("PriorityId").value = SelPriorityId
                }

            }

        });
    }



    function LoadSatus() {
        $.ajax({
            url: "/HDOperations/LoadSatus",
            success: function (data) {
                var StatusItems = $('#HDStatusId')
                StatusItems.children().remove();
                StatusItems.append($("<option>").val("null").text("--Select--"))
                $.each(data, function (i, record) {
                    StatusItems.append($("<option>").val(record.HDStatusId).text(record.HDStatusName));
                });
                $('#HDStatusId').append(StatusItems);
                var HDStatusId = $("#HDStatusIdSel").val()
                if (HDStatusId > 0) {
                    document.getElementById("HDStatusId").value = HDStatusId
                }

            }

        });
    }



    function LoadType() {
        $.ajax({
            url: "/HDOperations/LoadType",
            success: function (data) {
                var StatusItems = $('#HDTicketType')
                StatusItems.children().remove();
                StatusItems.append($("<option>").val("null").text("--Select--"))
                $.each(data, function (i, record) {
                    StatusItems.append($("<option>").val(record.HDTicketTypeId).text(record.HDTicketTypeName));
                });
                $('#HDTicketType').append(StatusItems);
                var HDStatusId = $("#HDTicketTypeIdSel").val()

                if (HDStatusId > 0) {
                    document.getElementById("HDTicketType").value = HDStatusId
                }

            }

        });
    }




    //function LoadCategory() {
    //    $.ajax({
    //        url: "/THelpDesk/LoadCategory",
    //        success: function (data) {
    //            var TypeItems = $('#TicketCategoryId')
    //            TypeItems.children().remove();
    //            TypeItems.append($("<option>").val("null").text("--Select--"))
    //            $.each(data, function (i, record) {
    //                TypeItems.append($("<option>").val(record.HDCategoryId).text(record.CategoryName));
    //            });
    //            $('#TicketCategoryId').append(TypeItems);
    //            var TicketCategoryIdSel = $("#TicketCategoryIdSel").val()

    //            if (TicketCategoryIdSel > 0) {
    //                document.getElementById("TicketCategoryId").value = TicketCategoryIdSel
    //            }


    //        }

    //    });
    //}


    function LoadStatusOwners() {
        var HDTicketStatusOwnerIdSel = $("#HDTicketStatusOwnerIdSel").val()
        var GroupId = $("#GroupId").val()
        if (GroupId > 0 || GroupId == 0) {
            $.ajax({
                url: "/HDOperations/LoadStatusOwners",
                data: { PlayerId: HDTicketStatusOwnerIdSel, GroupId: GroupId },
                success: function (data) {
                    var Staff = $('#HDTicketStatusOwnerId')
                    Staff.children().remove();
                    Staff.append($("<option>").val("null").text("--Select--"))
                    $.each(data, function (i, record) {
                        Staff.append($("<option>").val(record.StaffId).text(record.FirstName));
                    });
                    $('#HDTicketStatusOwnerId').append(Staff);
                    //var HDTicketStatusOwnerId = $("#StatusOwnerEmployeeNo").val()
                    //if (HDTicketStatusOwnerId != "" && HDTicketStatusOwnerId != null && HDTicketStatusOwnerId != "null") {
                    //    document.getElementById("HDTicketStatusOwnerId").value = HDTicketStatusOwnerId
                    //}
                }

            });
        }
        else {
            $('#HDTicketStatusOwnerId').html("");
        }

    }


    function Validations() {

        var Valid = true
        var HDStatusId = $("#HDStatusId").val();
        //var HDTicketTypeId = $("#HDTicketTypeId").val();
        var PriorityId = $("#PriorityId").val();
        //var HDTicketStatusOwnerId = $("#HDTicketStatusOwnerId").val();
        var selStatus = $('#SelStatusId').val();
        var TaskDescription = $('#TaskDescription').val();
        var GroupId = $('#GroupId').val();


        //if (selStatus == HDStatusId) {
        if (HDStatusId == "" || HDStatusId == "null" || HDStatusId == null) {
            document.getElementById("HDStatusIdVal").innerHTML = "Please select Status"
            Valid = false
        }
        //    else {
        //        document.getElementById("HDStatusIdVal").innerHTML = "Please change the status"
        //        Valid = false
        //    }
        //}

        if (TaskDescription == "" || TaskDescription == null) {
            $('#CommentVal').show();
            Valid = false;
        }

        //if (HDTicketTypeId == "" || HDTicketTypeId == "null" || HDTicketTypeId == null) {
        //    document.getElementById("HDTicketTypeIdVal").innerHTML = "Please select issue type"
        //    Valid = false
        //}


        if (PriorityId == "" || PriorityId == "null" || PriorityId == null) {
            document.getElementById("PriorityIdVal").innerHTML = "Please select priority"
            Valid = false
        }

        //if (HDTicketStatusOwnerId == "" || HDTicketStatusOwnerId == "null" || HDTicketStatusOwnerId == null) {
        //    var value = parseInt($("#HDStatusId").val());
        //    if (value == 3 || value == 4) {

        //    }
        //    else {
        //        document.getElementById("HDTicketStatusOwnerIdVal").innerHTML = "Please select issued to"
        //        Valid = false
        //    }

        //}

        if (GroupId == "" || GroupId == null) {
            if (value == 3 || value == 4) {

            }
            else {
                $('#HDGroupIdVal').show();
                Valid = false;
            }
        }


        return Valid;

    }

    function GetGroupsDropDown() {
        $.ajax({
            url: '/SeHelpDesk/GetGroupsDropDown',
            success: function (Data) {
                var Group = $('#GroupId')
                Group.children().remove();
                Group.append($("<option>").val("").text("--Select--"))
                $.each(Data, function (i, record) {
                    Group.append($("<option>").val(record.HDExecutiveGroupId).text(record.GroupName));
                });
                $('#GroupId').append(Group);
            }
        })


    }

    $("#HDStatusId").change(function () {
        var value = parseInt($(this).val());
        if (value == 3 || value == 4) {
            $('#divGroup').hide();
            $('#divStatusOwner').hide();
        }
        else {
            $('#divGroup').show();
            $('#divStatusOwner').show();
        }

        document.getElementById("HDStatusIdVal").innerHTML = ""
    })


    $("#HDTicketTypeId").change(function () {
        document.getElementById("HDTicketTypeIdVal").innerHTML = ""

    })


    $("#HDTicketStatusOwnerId").change(function () {
        document.getElementById("HDTicketStatusOwnerIdVal").innerHTML = ""

    })


    $("#PriorityId").change(function () {
        document.getElementById("PriorityIdVal").innerHTML = ""

    })
    $("#GroupId").change(function () {

        LoadStatusOwners();
    })

    window.onload = OnloadData();
</script>
